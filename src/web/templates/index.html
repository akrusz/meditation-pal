{% extends "base.html" %}

{% block title %}Meditation Pal{% endblock %}

{% block content %}
<div class="setup-container">
    <div class="setup-header">
        <div class="orb orb-idle"></div>
        <h1>Begin Your Practice</h1>
        <p class="setup-subtitle">Set an intention, choose how you'd like to be guided, then sit.</p>
    </div>

    <form id="setup-form" class="setup-form">
        <div class="form-group">
            <label for="intention">Intention <span class="optional">(optional)</span></label>
            <textarea
                id="intention"
                name="intention"
                rows="2"
                placeholder="e.g. Explore pleasant sensations... Practice jhana... Just be present... Let go and drift..."
            ></textarea>
        </div>

        <div class="form-group">
            <label>Facilitation Style</label>
            <div class="style-cards">
                <label class="style-card selected" data-style="pleasant_play">
                    <input type="radio" name="style" value="pleasant_play" checked>
                    <div class="style-card-inner">
                        <span class="style-name">Pleasant Play</span>
                        <span class="style-desc">Playful exploration of pleasant sensations and natural absorption</span>
                    </div>
                </label>
                <label class="style-card" data-style="adaptive">
                    <input type="radio" name="style" value="adaptive">
                    <div class="style-card-inner">
                        <span class="style-name">Adaptive</span>
                        <span class="style-desc">Flow with whatever arises, orienting toward your intention</span>
                    </div>
                </label>
                <label class="style-card" data-style="non_directive">
                    <input type="radio" name="style" value="non_directive">
                    <div class="style-card-inner">
                        <span class="style-name">Non-directive</span>
                        <span class="style-desc">Pure presence and reflection, no guidance</span>
                    </div>
                </label>
                <label class="style-card" data-style="somatic">
                    <input type="radio" name="style" value="somatic">
                    <div class="style-card-inner">
                        <span class="style-name">Somatic</span>
                        <span class="style-desc">Body-focused exploration of sensation</span>
                    </div>
                </label>
                <label class="style-card" data-style="open">
                    <input type="radio" name="style" value="open">
                    <div class="style-card-inner">
                        <span class="style-name">Open</span>
                        <span class="style-desc">Minimal facilitation, mostly holding space</span>
                    </div>
                </label>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group-half">
                <label for="directiveness">
                    Guidance Level
                    <span class="range-value" id="directiveness-value">3</span>
                </label>
                <input
                    type="range"
                    id="directiveness"
                    name="directiveness"
                    min="0"
                    max="10"
                    value="3"
                >
                <div class="range-labels">
                    <span>Following</span>
                    <span>Directing</span>
                </div>
            </div>

            <div class="form-group form-group-half">
                <label for="verbosity">Response Length</label>
                <select id="verbosity" name="verbosity">
                    <option value="low" selected>Brief</option>
                    <option value="medium">Medium</option>
                    <option value="high">Longer</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group-half">
                <label for="provider">Provider</label>
                <select id="provider" name="provider">
                    <option value="claude_proxy" selected>Anthropic (Subscription)</option>
                    <option value="anthropic">Anthropic (API Key)</option>
                    <option value="openrouter">OpenRouter</option>
                </select>
            </div>
            <div class="form-group form-group-half">
                <label for="model">Model</label>
                <select id="model" name="model">
                </select>
            </div>
        </div>
        <div id="provider-hint" class="provider-hint" style="display:none"></div>

        <div class="form-group">
            <label>Orientation</label>
            <div class="modifier-toggles">
                <label class="modifier-toggle">
                    <input type="checkbox" name="modifier" value="orient_pleasant" checked>
                    <div class="modifier-info">
                        <span class="modifier-name">Orient toward pleasant</span>
                        <span class="modifier-desc">Gently steer toward pleasant or neutral sensations</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="modifier" value="permission_to_enjoy">
                    <div class="modifier-info">
                        <span class="modifier-name">Permission to enjoy</span>
                        <span class="modifier-desc">Pleasure is valid — enjoyment is the practice</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="modifier" value="release_agenda">
                    <div class="modifier-info">
                        <span class="modifier-name">Release agenda</span>
                        <span class="modifier-desc">Non-attachment to outcomes, nowhere to get to</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="modifier" value="effortless">
                    <div class="modifier-info">
                        <span class="modifier-name">Effortless</span>
                        <span class="modifier-desc">Hands off the wheel — let things unfold</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="modifier" value="emotional_warmth">
                    <div class="modifier-info">
                        <span class="modifier-name">Emotional warmth</span>
                        <span class="modifier-desc">Explore emotions as doorways — feel the feeling behind the feeling</span>
                    </div>
                </label>
            </div>
        </div>

        <details class="advanced-settings">
            <summary>Additional instructions</summary>
            <div class="form-group">
                <textarea
                    id="custom_instructions"
                    name="custom_instructions"
                    rows="3"
                    placeholder="Any specific guidance for the facilitator..."
                ></textarea>
            </div>
        </details>

        <button type="submit" class="btn btn-primary btn-begin">
            Begin Session
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Provider → model mapping
    const providerModels = {
        claude_proxy: [
            { value: 'claude-sonnet-4-5-20250929', label: 'Claude Sonnet 4.5' },
            { value: 'claude-opus-4-6', label: 'Claude Opus 4.6' },
            { value: 'claude-opus-4-5-20251101', label: 'Claude Opus 4.5' },
            { value: 'claude-haiku-4-5-20251001', label: 'Claude Haiku 4.5' },
        ],
        anthropic: [
            { value: 'claude-sonnet-4-5-20250929', label: 'Claude Sonnet 4.5' },
            { value: 'claude-opus-4-6', label: 'Claude Opus 4.6' },
            { value: 'claude-opus-4-5-20251101', label: 'Claude Opus 4.5' },
            { value: 'claude-haiku-4-5-20251001', label: 'Claude Haiku 4.5' },
            { value: 'claude-3-opus-20240229', label: 'Claude 3 Opus' },
        ],
        openrouter: [
            { value: 'deepseek/deepseek-v3.2-20251201', label: 'DeepSeek V3.2' },
            { value: 'moonshotai/kimi-k2.5-0127', label: 'Kimi K2.5' },
            { value: 'moonshotai/kimi-k2-thinking-20251106', label: 'Kimi K2 Thinking' },
        ],
    };

    const providerSelect = document.getElementById('provider');
    const modelSelect = document.getElementById('model');
    const providerHint = document.getElementById('provider-hint');
    let providerStatus = {};  // populated by /api/providers

    function updateModelOptions() {
        const models = providerModels[providerSelect.value] || [];
        modelSelect.innerHTML = models.map(m =>
            `<option value="${m.value}">${m.label}</option>`
        ).join('');
        updateProviderHint();
    }

    function updateProviderHint() {
        const key = providerSelect.value;
        const info = providerStatus[key];
        if (info && !info.available) {
            providerHint.textContent = info.hint;
            providerHint.style.display = '';
        } else {
            providerHint.style.display = 'none';
        }
    }

    function applyProviderAvailability() {
        for (const opt of providerSelect.options) {
            const info = providerStatus[opt.value];
            if (info && !info.available) {
                opt.classList.add('provider-unavailable');
                opt.textContent = opt.textContent.replace(/ \u2718$/, '') + ' \u2718';
            } else {
                opt.classList.remove('provider-unavailable');
                opt.textContent = opt.textContent.replace(/ \u2718$/, '');
            }
        }
        updateProviderHint();
    }

    // Fetch provider availability from backend
    fetch('/api/providers')
        .then(r => r.json())
        .then(data => {
            providerStatus = data;
            applyProviderAvailability();
        })
        .catch(() => {});  // silently degrade

    providerSelect.addEventListener('change', updateModelOptions);
    updateModelOptions();

    // Style card selection
    document.querySelectorAll('.style-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.style-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
        });
    });

    // Range display
    const dirSlider = document.getElementById('directiveness');
    const dirValue = document.getElementById('directiveness-value');
    dirSlider.addEventListener('input', () => {
        dirValue.textContent = dirSlider.value;
    });

    // Form submit
    document.getElementById('setup-form').addEventListener('submit', (e) => {
        e.preventDefault();

        const modifiers = Array.from(
            document.querySelectorAll('input[name="modifier"]:checked')
        ).map(el => el.value);

        const params = {
            intention: document.getElementById('intention').value,
            style: document.querySelector('input[name="style"]:checked').value,
            directiveness: parseInt(dirSlider.value),
            modifiers: modifiers,
            verbosity: document.getElementById('verbosity').value,
            custom_instructions: document.getElementById('custom_instructions').value,
            provider: providerSelect.value,
            model: modelSelect.value,
        };

        sessionStorage.setItem('sessionParams', JSON.stringify(params));
        window.location.href = '/session';
    });
</script>
{% endblock %}
