{% extends "base.html" %}

{% block title %}Glooow{% endblock %}

{% block nav_center %}
<div class="nav-session-info">
    <div class="orb orb-idle orb-nav" id="home-orb"></div>
</div>
{% endblock %}

{% block content %}
<div class="setup-container">
    <div class="setup-header">
        <p class="setup-subtitle">Set an intention, choose how you'd like to be guided, then sit or lie down.</p>
    </div>

    <form id="setup-form" class="setup-form">
        <div class="form-group">
            <label for="intention">Intention <span class="optional">(optional)</span></label>
            <textarea
                id="intention"
                name="intention"
                rows="2"
                placeholder="e.g. Explore pleasant sensations... Practice jhana... Just be present... Let go and drift..."
            ></textarea>
        </div>

        <div class="form-group">
            <label>Quick Start</label>
            <div class="style-cards">
                <label class="style-card selected" data-preset="pleasant_play">
                    <input type="radio" name="preset" value="pleasant_play" checked>
                    <div class="style-card-inner">
                        <span class="style-name">Pleasant Play</span>
                        <span class="style-desc">Playfully exploring emotions, body sensations, jhana factors</span>
                    </div>
                </label>
                <label class="style-card" data-preset="warmth_goodwill">
                    <input type="radio" name="preset" value="warmth_goodwill">
                    <div class="style-card-inner">
                        <span class="style-name">Warmth & Goodwill</span>
                        <span class="style-desc">Orienting toward kind and loving feelings for yourself and others</span>
                    </div>
                </label>
                <label class="style-card" data-preset="parts_work">
                    <input type="radio" name="preset" value="parts_work">
                    <div class="style-card-inner">
                        <span class="style-name">Parts Work</span>
                        <span class="style-desc">Explore inner parts, speak to them, let them speak back</span>
                    </div>
                </label>
                <label class="style-card" data-preset="somatic">
                    <input type="radio" name="preset" value="somatic">
                    <div class="style-card-inner">
                        <span class="style-name">Somatic</span>
                        <span class="style-desc">Body-focused exploration of sensation and physical experience</span>
                    </div>
                </label>
                <label class="style-card" data-preset="freeform">
                    <input type="radio" name="preset" value="freeform">
                    <div class="style-card-inner">
                        <span class="style-name">Freeform</span>
                        <span class="style-desc">Spacious, effortless. Flow with whatever arises</span>
                    </div>
                </label>
                <label class="style-card" data-preset="stillness">
                    <input type="radio" name="preset" value="stillness">
                    <div class="style-card-inner">
                        <span class="style-name">Stillness</span>
                        <span class="style-desc">Minimal guidance, holding space for whatever wants to happen</span>
                    </div>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>Attention Focus</label>
            <div class="modifier-toggles">
                <label class="modifier-toggle">
                    <input type="checkbox" name="focus" value="body_sensations">
                    <div class="modifier-info">
                        <span class="modifier-name">Body & sensations</span>
                        <span class="modifier-desc">Physical experience - texture, temperature, movement</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="focus" value="emotions">
                    <div class="modifier-info">
                        <span class="modifier-name">Emotions & feeling tone</span>
                        <span class="modifier-desc">Emotional landscape, warmth, what's alive underneath</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="focus" value="inner_parts">
                    <div class="modifier-info">
                        <span class="modifier-name">Parts & inner world</span>
                        <span class="modifier-desc">Inner parts, protectors, body parts, speaking to/as parts</span>
                    </div>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>Facilitator Quality</label>
            <div class="modifier-toggles">
                <label class="modifier-toggle">
                    <input type="checkbox" name="quality" value="playful">
                    <div class="modifier-info">
                        <span class="modifier-name">Playful & light</span>
                        <span class="modifier-desc">Play, spontaneity, delight. Doesn't have to be serious.</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="quality" value="compassionate">
                    <div class="modifier-info">
                        <span class="modifier-name">Compassionate</span>
                        <span class="modifier-desc">Meeting what arises with care, tenderness, gentleness</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="quality" value="loving">
                    <div class="modifier-info">
                        <span class="modifier-name">Loving & kind</span>
                        <span class="modifier-desc">Generating and radiating love and goodwill</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="quality" value="spacious">
                    <div class="modifier-info">
                        <span class="modifier-name">Spacious</span>
                        <span class="modifier-desc">Notice the openness that's already here</span>
                    </div>
                </label>
                <label class="modifier-toggle">
                    <input type="checkbox" name="quality" value="effortless">
                    <div class="modifier-info">
                        <span class="modifier-name">Effortless</span>
                        <span class="modifier-desc">Hands off the wheel, let things unfold</span>
                    </div>
                </label>
            </div>
        </div>

        <div class="form-group">
            <div class="modifier-toggles single-col">
                <label class="modifier-toggle">
                    <input type="checkbox" name="orient_pleasant" id="orient_pleasant">
                    <div class="modifier-info">
                        <span class="modifier-name">Orient toward pleasant</span>
                        <span class="modifier-desc">Gently steer toward pleasant experience. It's good to feel good.</span>
                    </div>
                </label>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group-half">
                <label for="directiveness">Guidance Level</label>
                <input
                    type="range"
                    id="directiveness"
                    name="directiveness"
                    min="0"
                    max="4"
                    value="1"
                    step="1"
                >
                <div class="range-labels">
                    <span>Following</span>
                    <span>Directing</span>
                </div>
            </div>

            <div class="form-group form-group-half">
                <label for="verbosity">Response Length</label>
                <select id="verbosity" name="verbosity">
                    <option value="low">Brief</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">Longer</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group-half">
                <label for="provider">Provider</label>
                <select id="provider" name="provider">
                    <option value="claude_proxy" selected>Anthropic (Subscription)</option>
                    <option value="anthropic">Anthropic (API Key)</option>
                    <option value="openrouter">OpenRouter</option>
                    <option value="venice">Venice.ai (Private)</option>
                    <option value="ollama">Ollama (Local)</option>
                </select>
            </div>
            <div class="form-group form-group-half">
                <label for="model">Model</label>
                <select id="model" name="model">
                </select>
            </div>
        </div>
        <div id="provider-hint" class="provider-hint" style="display:none"></div>

        <details class="advanced-settings">
            <summary>Additional instructions</summary>
            <div class="form-group">
                <textarea
                    id="custom_instructions"
                    name="custom_instructions"
                    rows="3"
                    placeholder="Any specific guidance for the facilitator..."
                ></textarea>
            </div>
        </details>

        <button type="submit" class="btn btn-primary btn-begin">
            Begin Session
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ---- Presets ----
    const presets = {
        pleasant_play: {
            focuses: ['body_sensations', 'emotions'],
            qualities: ['playful'],
            orient_pleasant: true,
            dirStep: 1,  // Light
        },
        parts_work: {
            focuses: ['inner_parts', 'emotions'],
            qualities: ['compassionate'],
            orient_pleasant: false,
            dirStep: 1,  // Light
        },
        warmth_goodwill: {
            focuses: ['emotions'],
            qualities: ['loving'],
            orient_pleasant: true,
            dirStep: 2,  // Balanced
        },
        somatic: {
            focuses: ['body_sensations'],
            qualities: [],
            orient_pleasant: false,
            dirStep: 2,  // Balanced
        },
        freeform: {
            focuses: [],
            qualities: ['spacious', 'effortless'],
            orient_pleasant: false,
            dirStep: 1,  // Light
        },
        stillness: {
            focuses: [],
            qualities: ['spacious'],
            orient_pleasant: false,
            dirStep: 0,  // Following
        },
    };

    const dirSlider = document.getElementById('directiveness');
    const orientPleasant = document.getElementById('orient_pleasant');

    // Slider step â†’ backend directiveness value
    const dirValues = [0, 3, 5, 7, 10];
    function dirBackendValue() { return dirValues[dirSlider.value]; }

    function applyPreset(name) {
        const p = presets[name];
        if (!p) return;

        // Set focus checkboxes
        document.querySelectorAll('input[name="focus"]').forEach(cb => {
            cb.checked = p.focuses.includes(cb.value);
            cb.closest('.modifier-toggle').classList.toggle('selected', cb.checked);
        });

        // Set quality checkboxes
        document.querySelectorAll('input[name="quality"]').forEach(cb => {
            cb.checked = p.qualities.includes(cb.value);
            cb.closest('.modifier-toggle').classList.toggle('selected', cb.checked);
        });

        // Orient pleasant
        orientPleasant.checked = p.orient_pleasant;
        orientPleasant.closest('.modifier-toggle').classList.toggle('selected', p.orient_pleasant);

        // Directiveness
        dirSlider.value = p.dirStep;
    }

    // Preset card selection
    document.querySelectorAll('.style-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.style-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            const preset = card.dataset.preset;
            if (preset) applyPreset(preset);
        });
    });

    // When user manually changes checkboxes/slider, deselect preset cards
    function deselectPresets() {
        document.querySelectorAll('.style-card').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('input[name="preset"]').forEach(r => r.checked = false);
    }

    document.querySelectorAll('input[name="focus"], input[name="quality"], #orient_pleasant').forEach(cb => {
        cb.addEventListener('change', () => {
            cb.closest('.modifier-toggle').classList.toggle('selected', cb.checked);
            deselectPresets();
        });
    });

    dirSlider.addEventListener('input', () => {
        deselectPresets();
    });

    // Apply default preset on load
    applyPreset('pleasant_play');

    // ---- Provider / Model ----
    const providerModels = {
        claude_proxy: [
            { value: 'claude-sonnet-4-5-20250929', label: 'Claude Sonnet 4.5' },
            { value: 'claude-opus-4-6', label: 'Claude Opus 4.6' },
            { value: 'claude-opus-4-5-20251101', label: 'Claude Opus 4.5' },
            { value: 'claude-haiku-4-5-20251001', label: 'Claude Haiku 4.5' },
        ],
        anthropic: [
            { value: 'claude-sonnet-4-5-20250929', label: 'Claude Sonnet 4.5' },
            { value: 'claude-opus-4-6', label: 'Claude Opus 4.6' },
            { value: 'claude-opus-4-5-20251101', label: 'Claude Opus 4.5' },
            { value: 'claude-haiku-4-5-20251001', label: 'Claude Haiku 4.5' },
            { value: 'claude-3-opus-20240229', label: 'Claude 3 Opus' },
        ],
        openrouter: [
            { value: 'deepseek/deepseek-v3.2-20251201', label: 'DeepSeek V3.2' },
            { value: 'moonshotai/kimi-k2.5-0127', label: 'Kimi K2.5' },
            { value: 'meta-llama/llama-3.3-70b-instruct', label: 'Llama 3.3 70B' },
            { value: 'qwen/qwen3-235b-a22b-instruct-2507', label: 'Qwen3 235B' },
            { value: 'deepseek/deepseek-r1', label: 'DeepSeek R1' },
        ],
        venice: [
            { value: 'llama-3.3-70b', label: 'Llama 3.3 70B' },
            { value: 'kimi-k2-5', label: 'Kimi K2.5' },
            { value: 'qwen3-235b-a22b-instruct-2507', label: 'Qwen3 235B' },
            { value: 'deepseek-ai-DeepSeek-R1', label: 'DeepSeek R1' },
        ],
        ollama: [],  // populated from /api/providers
    };

    const providerSelect = document.getElementById('provider');
    const modelSelect = document.getElementById('model');
    const providerHint = document.getElementById('provider-hint');
    let providerStatus = {};  // populated by /api/providers

    function updateModelOptions() {
        const models = providerModels[providerSelect.value] || [];
        modelSelect.innerHTML = models.map(m =>
            `<option value="${m.value}">${m.label}</option>`
        ).join('');
        updateProviderHint();
    }

    function updateProviderHint() {
        const key = providerSelect.value;
        const info = providerStatus[key];
        if (info && !info.available) {
            providerHint.textContent = info.hint;
            providerHint.style.display = '';
        } else {
            providerHint.style.display = 'none';
        }
    }

    function applyProviderAvailability() {
        for (const opt of providerSelect.options) {
            const info = providerStatus[opt.value];
            if (info && !info.available) {
                opt.classList.add('provider-unavailable');
                opt.textContent = opt.textContent.replace(/ \u2718$/, '') + ' \u2718';
            } else {
                opt.classList.remove('provider-unavailable');
                opt.textContent = opt.textContent.replace(/ \u2718$/, '');
            }
        }
        updateProviderHint();
    }

    // Fetch provider availability from backend
    fetch('/api/providers')
        .then(r => r.json())
        .then(data => {
            providerStatus = data;
            // Populate ollama models from server response
            if (data.ollama && data.ollama.models && data.ollama.models.length) {
                providerModels.ollama = data.ollama.models.map(name => ({
                    value: name,
                    label: name.replace(/:latest$/, ''),
                }));
            }
            applyProviderAvailability();
            updateModelOptions();  // refresh in case ollama is selected
        })
        .catch(() => {});  // silently degrade

    providerSelect.addEventListener('change', updateModelOptions);
    updateModelOptions();

    // Home orb bounce on click
    const homeOrb = document.getElementById('home-orb');
    if (homeOrb) {
        homeOrb.addEventListener('click', () => {
            homeOrb.classList.remove('orb-bounce');
            void homeOrb.offsetWidth; // reflow to restart animation
            homeOrb.classList.add('orb-bounce');
        });
        homeOrb.addEventListener('animationend', () => {
            homeOrb.classList.remove('orb-bounce');
        });
    }

    // ---- Form submit ----
    document.getElementById('setup-form').addEventListener('submit', (e) => {
        e.preventDefault();

        const focuses = Array.from(
            document.querySelectorAll('input[name="focus"]:checked')
        ).map(el => el.value);

        const qualities = Array.from(
            document.querySelectorAll('input[name="quality"]:checked')
        ).map(el => el.value);

        const params = {
            intention: document.getElementById('intention').value,
            focuses: focuses,
            qualities: qualities,
            orient_pleasant: orientPleasant.checked,
            directiveness: dirBackendValue(),
            verbosity: document.getElementById('verbosity').value,
            custom_instructions: document.getElementById('custom_instructions').value,
            provider: providerSelect.value,
            model: modelSelect.value,
        };

        sessionStorage.setItem('sessionParams', JSON.stringify(params));
        window.location.href = '/session';
    });
</script>
{% endblock %}
